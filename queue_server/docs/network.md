# 네트워크 계층 설계 - 이슈 대응 중심 설계

## 설계 목적

- 대기열 서버 아키텍처를 **현실적인 네트워크 환경에서 발생 가능한 장애**에 대응할 수 있도록 함
- 단순 라우팅/트래픽 처리뿐 아니라, **지연, 장애, 보안, 부하 분산** 등 다양한 이슈에 대응할 수 있도록 설계
- 본 시스템은 두 개의 IDC를 기반으로 설계되며, 각 IDC는 하나의 Availability Zone(AZ)에 해당
- 네트워크는 OVN(Open Virtual Network)을 통해 가상화되어 있으며, 서비스 노드들은 논리적으로 동일한 네트워크 세그먼트 안에서 통신
- 물리 네트워크는 고대역폭(Backbone) 네트워크와 저대역폭 네트워크로 구분되어 있으며, 필요 시 서비스 인스턴스의 네트워크 위치를 재배치


## 1. 트래픽 폭주 (Burst Traffic)

### 문제

- 이벤트 시작 시 **짧은 시간에 수만 건의 요청**이 집중 발생
- L7 프록시 또는 FastAPI 서버가 처리 불가능한 수준까지 올라감

### 고려 사항

- 앞단 L7 LB(gateway)에서 연결 가능한 connection pool size 초과 가능성
- 요청을 기다리는 동안 gateway timeout (504) 발생 가능


### 대응 설계

- LB 이중화를 통해 LB 트래픽 부담을 줄면서 HA를 보장함 (해당 LB는 다른 AZ에 배치)


## 2. 네트워크 지연 (Latency)

### 문제

- 평소엔 고대역폭이 필요하지 않고, 특정 이벤트에서만 고대역폭이 필요
- 트래픽이 몰리는 상황에서 L2 단계에서 congestion 발생

- 외부 서비스와 네트워크에 미치는 영향

OVN 환경에서는 논리적으로 분리된 네트워크라도, 동일한 물리 네트워크 자원(NIC, uplink, bridge)을 공유하므로, 한 VPC 또는 서비스의 트래픽 폭주가 다른 서비스의 네트워크 품질에 영향을 줄 수 있다.
이를 방지하기 위해 물리 인터페이스 분리, QoS 정책, OVN flow 우선순위 조정 등의 대응 설계가 필요하다.

### 대응 설계

- instance(LB, 대기열 서버)를 dynamic하게 고대역폭 (back-bone) 이동시킬 수 있게 한다
- OVN 기반 네트워크 가상화를 활용해, public IP를 유지한 채 서비스 인스턴스를 고대역폭 링크가 연결된 IDC로 동적으로 재배치할 수 있다. 이로써 특정 이벤트 발생 시 일시적으로 고대역폭을 활용한 네트워크 최적화가 가능하다.


## 3. 연결 상태 불안정 (Client Drop, 중간 끊김)

### 문제

- 클라이언트의 중간 이탈 시 대기열 자원 낭비
- 사용자 체감 대기시간에 비해 실제 입장이 늦어짐

### 대응 설계

- 클라이언트는 `polling` 또는 `WebSocket` 기반 **heartbeat 신호 주기적 전송**
- Redis ZSET의 `last_seen_timestamp` 기준으로 일정 시간 미응답 시 자동 제거
- TTL 적용 (예: 3분) → ticket 및 queue entry 만료


